<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script src="../../lib/jquery.js"></script>
    <link href="../../style/global.css" rel="stylesheet" />
    <style>
        .bgimg {
            background-image: url('../../pics/back3.jpg');
        }

        .homeBtn {
            border: 1px solid #000;
            color: #000;
        }

        #btnDiv,
        #bottomDiv {
            color: black;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
        }

        table tr td {
            padding: 10px 30px;
        }

        .mess {
            text-align: center;
            margin-bottom: 30px;
        }

        #chartContainer {
            margin: auto;
        }

        .form-box {
            width: 800px;
            background: rgba(50, 50, 50, 0.9);
            margin: 1% auto 1% auto;
            padding: 10px 20px 0 20px;
            color: #fff;
            box-shadow: 0 0 20px 2px rgba(100, 100, 200, 1);
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
            border: 1px solid #ddd;
        }

        th,
        td {
            text-align: center;
            padding: 10px;
        }

        /* th:first-child,
        td:first-child {
            text-align: left;
        } */

        .fa-check {
            color: green;
        }

        .fa-remove {
            color: red;
        }
    </style>
</head>

<body dir="rtl">
    <div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
        <div class="w3-display-topleft w3-padding-large w3-xlarge" id="btnDiv">
            שולחן משחקים שיתופי
            <br>
            <button type="button" class="homeBtn" id="btn_goToHome">
                <img id="homeImg" src="../../pics/homeBtn.png" alt="">
            </button>
        </div>
        <div class="form-box w3-display-middle">
            <h1>הצגת ציונים וגרף התקדמות <span id="nameChild"></span></h1>
            <div id="err_text"></div>
            <div class="mess" id="data">

            </div>

        </div>


        <div class="w3-display-bottomleft w3-padding-large" id="bottomDiv">
            Make Learning Fun
        </div>
    </div>


    <script type="module" src="consts.js"></script>
    <script type="module" src="api.js"></script>
    <script type="module">
        import { getStatsRequest } from './api.js';
        import { URL } from './consts.js';

        $(document).ready(() => {
            console.log('jquery work');
            let child_id = JSON.parse(localStorage.getItem('child')).id;
            getStatsRequest(child_id, setData, printErrorToUser);

            init();
        });

        function init() {
            $('#btn_goToHome').on('click', () => {
                // window.location.href = URL.CHILD_HOME;
                window.history.back();
            });

            displayNameTitle();
            // disableBackBtn();
        }

        function setData(data) {
            if (data.length === 0) return printErrorToUser(0, 'אין תוצאות לילד זה.');
            let $h_tr = $('<tr>').append($('<th>').text('תאריך'), $('<th>').text('סך הכל שאלות'),
                $('<th>').text('חיבור'), $('<th>').text('חיסור'), $('<th>').text('כפל'), $('<th>').text('ציון'));
            let $table = $('<table>').append($h_tr);
            let sheets = data[0].sheets;
            for (let i = 0; i < sheets.length; i++) {
                console.log(sheets[i]);
                let $td0 = $('<td>').text(formatDate(sheets[i].date.substr(0, 10)));
                let $td1 = $('<td>').text(sheets[i].number_of_questions);
                let $td2 = $('<td>').text(`${sheets[i].questions[0].asked} / ${sheets[i].questions[0].correct} `);
                let $td3 = $('<td>').text(`${sheets[i].questions[1].asked} / ${sheets[i].questions[1].correct} `);
                let $td4 = $('<td>').text(`${sheets[i].questions[2].asked} / ${sheets[i].questions[2].correct} `);
                let score = calculateScore(sheets[i]);
                let scoreColor = (score >= 60) ? 'green' : 'red';
                let $td5 = $('<td>').text(`% ${score}`).css('color', scoreColor);
                $table.append($('<tr>').append($td0, $td1, $td2, $td3, $td4, $td5));
            }
            $('#data').append($table);

            // $('tr:even').css('backgroundColor', 'gray');

            console.log();
        }

        function calculateScore(sheet) {
            let sumOfCorrect = 0;
            sheet.questions.forEach(q => {
                sumOfCorrect = sumOfCorrect + q.correct;
            });

            return parseInt(sumOfCorrect * 100 / sheet.number_of_questions);
        }

        function displayNameTitle() {
            let child = JSON.parse(localStorage.getItem('child'));
            $('#nameChild').text(`${child.firstName} ${child.lastName}`);
        }

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;

            return [day, month, year].join('-');
        }

        // function disableBackBtn() {
        //     history.pushState(null, null, document.URL);
        //     window.addEventListener('popstate', function () {
        //         history.pushState(null, null, document.URL);
        //     });
        // }

        function printErrorToUser(code, err) { // popup
            $('#err_text').text(err);
        }
    </script>
</body>

</html>